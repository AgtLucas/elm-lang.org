<!DOCTYPE HTML>
<html><head><meta charset="UTF-8"><title>Escape from Callback Hell - Elm</title><meta http-equiv="X-UA-Compatible" content="IE=edge"><style type="text/css">html,head,body { padding:0; margin:0; }body { font-family: helvetica, arial, sans-serif; }</style><style type="text/css">a:link {text-decoration: none; color: rgb(15,102,230);}a:visited {text-decoration: none}a:active {text-decoration: none}a:hover {text-decoration: underline; color: rgb(234,21,122);}</style></head><body><div id="widthChecker" style="width:100%; height:1px; position:absolute; top:-1px;"></div><div id="content"></div><noscript><p><style type="text/css">p { text-align:justify; }</style>

<h1><div style="text-align:center">
Escape from Callback Hell
<div style="font-size:0.5em;font-weight:normal">
<em>Callbacks are the modern <code>goto</code></em>
</div></div>
</h1>


</p><p><div style="color:#666;font-size:0.6em;text-align:left">
“The unbridled use of the go to statement has an immediate consequence that it becomes terribly hard to find a meaningful set of coordinates in which to describe the process progress.”
</div>
<div style="height:0.5em"></div>
<div style="color:#666;font-size:0.6em;text-align:right">
<a href="http://www.u.arizona.edu/~rubinson/copyright_violations/Go_To_Considered_Harmful.html" title="goto">Edsger Dijkstra</a>
</div>




</p><p><div style="color:#666;font-size:0.6em;text-align:left">
“For a number of years I have been familiar with the observation that the quality of programmers is a decreasing function of the density of go to statements in the programs they produce.”
</div>
<div style="height:0.5em"></div>
<div style="color:#666;font-size:0.6em;text-align:right">
<a href="http://www.u.arizona.edu/~rubinson/copyright_violations/Go_To_Considered_Harmful.html" title="goto">Edsger Dijkstra</a>
</div>




</p><p><p>Callbacks are used to structure programs. They let us say, “When this value is ready, go to another function and run that.” From there, maybe you go to <em>another</em> function and run that too. Pretty soon you are jumping around the whole codebase.</p>
<p>If you have worked with <a href="http://en.wikipedia.org/wiki/Ajax_(programming)" title="AJAX">AJAX</a> or <a href="http://nodejs.org" title="node.js">node.js</a> or any other callback heavy framework, you have probably been to Callback Hell. Your whole application ends up being passed around as callbacks, making the code extremely difficult to read and maintain. The resulting tangled mess of code is often pejoritively called <a href="http://en.wikipedia.org/wiki/Spaghetti_code" title="Spaghetti code">spaghetti code</a>, a term borrowed from the days of <code>goto</code>.</p>
<p>Just like <code>goto</code>, these callbacks force you to jump around your codebase in a way that is really hard to understand. You basically have to read the whole program to understand what any individual function does.</p>
<p>And good luck if you want to add something to your code. A change in one function may break functions that <em>appear</em> to be unrelated (the functions may never even appear together in the entire codebase, connected only by deeply nested callbacks). You'll usually find yourself carefully tracing through the entire sequence of callbacks to find out what your change will really do.</p>
<p>If you are not convinced that callbacks and <code>goto</code> are equally harmful, read Edsger Dijkstra's famous <a href="http://www.u.arizona.edu/~rubinson/copyright_violations/Go_To_Considered_Harmful.html" title="goto">“Go To Statement Considered Harmful”</a> and replace the mentions of <code>goto</code> with mentions of callbacks.</p>
<p>Okay, so there are a lot of things to dislike about callbacks, but they <em>do</em> serve a vital role in modern programs. In an effort to reach a better solution we must ask: why do we <em>really</em> need callbacks? What task do they perform? What is their fundamental role in our programs?</p>
<p>Well we often want to say, “When this value is ready, take this action.” This is a time-dependent relationship. We depend on a value as it changes over time. We also want to say, “While this is happening, that can happen too.” This is a time-dependent relationship too. These computations can happen concurrently. These time relationships are not covered by traditional control structures, so we use the modern <code>goto</code> to work around it.</p>
<h2 id="a-preview-of-the-solution">A Preview of the Solution</h2>
<p>Just like <code>goto</code>, callbacks lead to non-linear code that is hard to read, maintain, and understand. And just like with <code>goto</code>, this problem can be solved by introducing higher level control flow mechanisms. So if you want to escape from Callback Hell, you need to understand <a href="/learn/What-is-FRP.elm" title="FRP">Functional Reactive Programming</a> (FRP). In short:</p>
<div style="text-align:center">
<a href="http://www.u.arizona.edu/~rubinson/copyright_violations/Go_To_Considered_Harmful.html" title="goto">goto</a>   <strong>:</strong>   <a href="http://en.wikipedia.org/wiki/Structured_programming" title="Structured Programming">structured programming</a>   <strong>: :</strong>   <a href="http://en.wikipedia.org/wiki/Callback_(computer_programming)" title="Callbacks">callbacks</a>   <strong>:</strong>   <a href="/learn/What-is-FRP.elm" title="FRP">reactive programming</a>
</div>

<br/></p><p><p><a href="/learn/What-is-FRP.elm" title="FRP">Functional Reactive Programming</a> (FRP) is a high-level framework for describing time-dependent relationships. FRP formalizes these time-dependencies, resulting in simple syntax and semantics.</p>
<p>FRP lets you make asynchronous calls without the callbacks. Without the non-linear control flow. Without the headache. You can write code that is both readable <em>and</em> responsive.</p>
<p>To understand the existing problem and how it is solved with FRP, let's make this more concrete. The following example will explain the current state of affairs and fully explain how to create readable, responsive code that is entirely free of callbacks.</p></p><p><div style="color:#666;font-size:0.6em;text-align:left">
<strong>Function Specifications</strong>
</div>
<div style="height:0.5em"></div>
<div style="color:#666;font-size:0.6em;text-align:left">
<code>requestTag</code> which turns a tag – such as <code>&quot;badger&quot;</code> – into a valid Flickr API request. These requests will return a JSON object containing a list of <code>&quot;badger&quot;</code> photos.
</div>
<div style="height:0.5em"></div>
<div style="color:#666;font-size:0.6em;text-align:left">
<code>requestOneFrom</code> takes a JSON object of photos and turns it into a request for just <em>one</em> photo. This request will return a JSON object of size options. Flickr is basically asking, “Do you want low resolution? Original quality? 800 by 600? ...” This function also handles any errors that might have occured with the previous request.
</div>
<div style="height:0.5em"></div>
<div style="color:#666;font-size:0.6em;text-align:left">
<code>sizesToPhoto</code> turns a JSON object of sizes options into an actual image that we can use. Again, this function handles any errors that might have occured with the previous request.
</div>
<div style="height:0.5em"></div>
<div style="color:#666;font-size:0.6em;text-align:left">
<code>drawOnScreen</code> puts the image on screen for the user to see. You do not need to mess around with the DOM in <a href="/">Elm</a>, so this function only gets used in the JS code.
</div>


</p><p><h2 id="case-study-using-the-flickr-api">Case Study: Using the Flickr API</h2>
<p>Flickr – a photo sharing service – exposes an <a href="http://www.flickr.com/services/api/" title="Flickr API">API</a> that allows you to programmatically find and download photos. We want to find an image with a user defined tag. So if I ask for “Tokyo” I should get back a random image with a Tokyo tag.</p>
<p>This requires two explicit HTTP requests to Flickr, one to find some tagged photos and another to get the size options for a given image.</p>
<p>We will perform this task three ways: synchronously, asynchronously with callbacks, and asynchronously with FRP.</p>
<h4 id="readable-but-unresponsive">1. Readable but Unresponsive</h4>
<p>First let's do this with synchronous HTTP requests. We will rely on a couple of functions specified to the right. Here is our code:</p>
<pre><code>    function getPhoto(tag) {
        var photoList  = syncGet(requestTag(tag));
        var photoSizes = syncGet(requestOneFrom(photoList));
        return sizesToPhoto(photoSizes);
    }

    drawOnScreen(getPhoto(&#39;tokyo&#39;));</code></pre>
<p>It's pretty clear what is going on here. The <code>syncGet</code> function takes a request and blocks until it receives a response. The logic of the program is simple and linear. If you wanted to add anything, it is pretty obvious where it would go. You never have moments where you need a value but it does not exist yet.</p>
<p>This code is really nice to read, but it will make your whole application freeze for the duration of the HTTP requests. It basically dodges the issue of time-dependence by just freezing if it is waiting for a value. This blocks everything in the program. Mouse and keyboard input just piles up, waiting to be processed, presenting the user with an unresponsive app. This is not an acceptable user experience.</p>
<h4 id="responsive-but-unreadable">2. Responsive but Unreadable</h4>
<p>The current solution is to instead make asynchronous HTTP requests (AJAX requests) that use callbacks that give finer-grained control over time-dependencies.</p>
<pre><code>    function getPhoto(tag, handlerCallback) {
        asyncGet(requestTag(tag), function(photoList) {
            asyncGet(requestOneFrom(photoList), function(photoSizes) {
                handlerCallback(sizesToPhoto(photoSizes));
            });
        });
    }

    getPhoto(&#39;tokyo&#39;, drawOnScreen);</code></pre>
<p>The <code>asyncGet</code> function takes a request and a callback to run once a response is received. We can now say, “These computations must happen one after another, but other things can happen in the meantime.”</p>
<p>Yay, we solved the problem of the site freezing, but now our code is a mess of deeply nested functions that is annoying to write and unpleasant to read and maintain. This is a glimpse into Callback Hell.</p>
<p>We have effectively done a manual conversion to <a href="http://matt.might.net/articles/by-example-continuation-passing-style/" title="cps">continuation passing style (CPS)</a>, a common compiler technique for functional languages.</p>
<p>CPS is great for compilers because it is easy to map onto assembly-level jumps (i.e. <code>goto</code>), helping <a href="http://matt.might.net/articles/cps-conversion/" title="Compiling with Continuations">make functional languages efficient</a>! CPS is terrible for humans for the same reason. It is pretty much the same as using <code>goto</code> to structure your programs.</p></p><p><h4 id="readable-and-responsive">3. Readable <em>and</em> Responsive</h4>
<p><a href="/learn/What-is-FRP.elm" title="FRP">Functional Reactive Programming</a> uses <em>signals</em>, values that change over time, to represent all interactive time-varying content. For example, the value of a text input field is a “signal” because it changes over time. We can create such a signal with:</p>
<pre><code>    (inputField, tags) = Input.textField &quot;Tag&quot;</code></pre>
<p>This creates two values. The first is a visual element called <code>inputField</code> that users can type into. This is a normal text box. The second is a signal called <code>tags</code>. The value of <code>tags</code> changes automatically as the user types into <code>inputField</code>. Here are the <code>inputField</code> and the <code>tags</code> signal in action. Try typing into the input box to see <code>tags</code> update automatically.</p></p><p><p>We can then do all sorts of computations with <code>tags</code>. When <code>tags</code> changes the signals that depend on it change automatically:</p></p><p><p>The <code>lift</code> function is used to transform a signal. It takes functions such as <code>length</code>, <code>reverse</code>, or <code>requestTag</code> and applies them to a signal. This lets us create new signals that automatically change whenever <code>tags</code> changes.</p>
<p>We are particularly interested in the third signal we created. The code <code>(lift requestTag tags)</code> produces a Flickr request that corresponds to the current user input (abbreviated for the sake of presentation). Now we just need to send this request! For this we use the <code>send</code> function:</p></p><p><p>Notice that when <code>tags</code> changes, the result of <code>send</code> does <em>not</em> change immediately. The responses are sent and received asynchronously, so a response only arrives when it is ready. In the meantime, your program is free to go about its normal business.</p>
<p>This is great because it allows us to have asynchrony without leaving the conceptual framework of signals. The response is just another signal, exactly the same as <code>tags</code>. We can turn its values into requests and send them too. In fact, that's exactly what we are going to do. Here is the full Elm code for making many requests to the Flickr API:</p>
<pre><code>    getPhotos tags =
        let photoList  = send (lift requestTag tags) in
        let photoSizes = send (lift requestOneFrom photoList) in
            lift sizesToPhoto photoSizes</code></pre>
<p>We have effectively set up a processing pipeline of how to handle user input: we take in a tag, turn it into a request, send it, turn the response into a new request, send it, and finally turn <em>that</em> response into an image!</p>
<p>We have clear, linear control flow, and the resulting program automatically optimizes for asynchrony. It does not block while waiting for a response and our program is still well defined. We now have the readability of synchronous code with the efficiency of asynchronous callbacks. There is no trade-off between readability and responsiveness!</p>
<p>And because it is so easy to work with graphics in Elm, we can create a workable Flickr search interface with only four additional lines of code! The <a href="/edit/examples/Intermediate/Flickr.elm" title="Flickr API Example">full source code and interface can be seen here</a>, with a more idiomatic implementation of <code>getPhotos</code> that takes only one line. Take a look! All of the graphics code lives in the definition of <code>scene</code>, taking up a grand total of two lines. All told, <a href="/edit/examples/Intermediate/Flickr.elm" title="Flickr API Example">the core logic</a> is seven lines from start to finish.</p>
<p>In fact, here is an abbreviated version that fits in this blog post:</p>
<pre><code>    scene img = flow down [ container 300  60 middle inputField
                          , fittedImage 300 300 img ]

    main = lift scene (getPhotos (dropRepeats tags))</code></pre>
<p>In <code>scene</code> we stack two elements vertically so that they flow downward. The first one is a 300 by 60 container with our <code>inputField</code> text field right in the middle. The second is an image that is automatically cropped to fit nicely in a 300 by 300 square. The <code>main</code> function is what actually gets put on screen. The only new thing in this line is <code>dropRepeats</code> which filters out any values that are repeated, cutting down the number of HTTP requests we make. The result looks like this:</p></p><p>Flickr Search</p><p>http://api.flickr.com/services/rest/?format=json&nojsoncallback=1&api_key=256663858aa10e52a838a58b7866d858</p><p></p><p>&method=flickr.photos.search&sort=random&per_page=10&tags=</p><p>id</p><p></p><p></p><p>&method=flickr.photos.getSizes&photo_id=</p><p>source</p><p>source</p><p>/grey.jpg</p><p>size</p><p>sizes</p><p><h2 id="conclusions">Conclusions</h2>
<p>Callbacks are the modern <code>goto</code>. Callbacks result in non-linear code that is hard to read, maintain, and understand. Functional Reactive Programming introduces high-level control structures that let you easily express time-dependencies. The resulting code is both readable, responsive, and significantly more concise.</p>
<p>Signals can express <a href="/docs/Signal/Signal.elm" title="Signal Docs">many different time-relationships</a>, such as dependence on the <a href="/edit/examples/Intermediate/Clock.elm" title="Clock">present</a> or <a href="/edit/examples/Intermediate/Stamps.elm" title="Stamps">past</a>, time-sensitive <a href="/edit/examples/Reactive/SampleOn.elm" title="sampleOn">sampling</a> and <a href="/edit/examples/Reactive/KeepIf.elm" title="keepIf">filtering</a>, and <a href="/edit/examples/JavaScript/ZipCodes.elm" title="Zip Codes">asynchrony</a>. This makes it much easier to deal with complicated time-dependent interactions, a task that is extremely common when designing user interfaces.</p>
<p>Look out for an upcoming post on <strong>integrating Elm with JS code</strong>. This post will show how Elm can be used to handle your time dependent logic without disrupting an existing codebase. So you can use FRP to escape Callback Hell and still directly use JavaScript, JQuery, Bootstrap, or any other existing web technology. Until then, you can read up on the <a href="http://www.testblogpleaseignore.com/2012/06/29/announcing-elm-0-3-5-javascript-integration-signal-filters-and-more/" title="JavaScript Event Interface">JavaScript Event Interface</a> which makes this all possible.</p>
<p>If you interested in this approach, <a href="https://github.com/evancz/Elm/blob/master/README.md#elm" title="Dowload">download Elm</a> or <a href="http://elm-lang.org/edit/examples/Basic.elm">experiment online</a>! Elm is only at version 0.5, but it already has lots of great <a href="/Documentation.elm">libraries</a>. If you feel like there are some libraries or features missing, <a href="/Contribute.elm">you can help add them</a>.</p>
<p>If you have questions or want to learn more, there are lots of helpful resources. This <a href="http://www.testblogpleaseignore.com/wp-content/uploads/2012/04/thesis.pdf" title="thesis">thesis</a> has much more information on how asynchrony works in Elm. It also describes the history of FRP. It is quite accessible even if you do not have any experience reading academic papers. You can also email <a href="https://groups.google.com/forum/?fromgroups#!forum/elm-discuss" title="elm-discuss">the list</a> or ask questions on the <a href="http://webchat.freenode.net/?channels=elm" title="#elm channel">#elm channel at freenode</a>.</p></p><p>Tag</p><p></p><p>api.flickr.com/?tags=</p><p>Success "...  ..."</p><p>Waiting</p><p>Failure  "..."</p><p>lift length tags</p><p>lift reverse tags</p><p>lift requestTag tags</p><p>send (lift requestTag tags)</p><p></p><p>&method=flickr.photos.search&sort=random&per_page=10&tags=</p><p>Escape from Callback Hell</p></noscript><script type="text/javascript" src="/elm-mini.js"></script><script type="text/javascript">
try{

for(var i in Elm) { this[i] = Elm[i]; }
if (Elm.Main) throw "Module name collision, 'Main' is already defined."; 
Elm.Main=function(){
 try{if (!(Elm.Prelude instanceof Object)) throw 'module not found'; } catch(e) {throw "Module 'Prelude' is missing. Compile with --make flag or load missing module in a separate JavaScript file.";}
 try{if (!(Elm.Website.Skeleton instanceof Object)) throw 'module not found'; } catch(e) {throw "Module 'Website.Skeleton' is missing. Compile with --make flag or load missing module in a separate JavaScript file.";}
 var hiddenVars=[];
 for(var i in Elm.Website.Skeleton){
  if (hiddenVars.indexOf(i) >= 0) continue;
  this[i]=Elm.Website.Skeleton[i];}
 try{if (!(Elm.HTTP instanceof Object)) throw 'module not found'; } catch(e) {throw "Module 'HTTP' is missing. Compile with --make flag or load missing module in a separate JavaScript file.";}
 var hiddenVars=[];
 for(var i in Elm.HTTP){
  if (hiddenVars.indexOf(i) >= 0) continue;
  this[i]=Elm.HTTP[i];}
 try{if (!(Elm.JSON instanceof Object)) throw 'module not found'; } catch(e) {throw "Module 'JSON' is missing. Compile with --make flag or load missing module in a separate JavaScript file.";}
 var hiddenVars=[];
 for(var i in Elm.JSON){
  if (hiddenVars.indexOf(i) >= 0) continue;
  this[i]=Elm.JSON[i];}
 var intro_0=text('<div style="height:0;width:0;">&nbsp;</div><style type="text/css">p { text-align:justify; }</style>\n\n<h1><div style="text-align:center">\nEscape from Callback Hell\n<div style="font-size:0.5em;font-weight:normal">\n<em>Callbacks are the modern <code>goto</code></em>\n</div></div>\n</h1>\n\n\n<div style="height:0;width:0;">&nbsp;</div>');
 var quote1_1=above(spacer(170)(200))(width(170)(text('<div style="height:0;width:0;">&nbsp;</div><div style="color:#666;font-size:0.6em;text-align:left">\n“The unbridled use of the go to statement has an immediate consequence that it becomes terribly hard to find a meaningful set of coordinates in which to describe the process progress.”\n</div>\n<div style="height:0.5em"></div>\n<div style="color:#666;font-size:0.6em;text-align:right">\n<a href="http://www.u.arizona.edu/~rubinson/copyright_violations/Go_To_Considered_Harmful.html" title="goto">Edsger Dijkstra</a>\n</div>\n\n\n\n\n<div style="height:0;width:0;">&nbsp;</div>')));
 var quote2_2=above(spacer(170)(40))(width(170)(text('<div style="height:0;width:0;">&nbsp;</div><div style="color:#666;font-size:0.6em;text-align:left">\n“For a number of years I have been familiar with the observation that the quality of programmers is a decreasing function of the density of go to statements in the programs they produce.”\n</div>\n<div style="height:0.5em"></div>\n<div style="color:#666;font-size:0.6em;text-align:right">\n<a href="http://www.u.arizona.edu/~rubinson/copyright_violations/Go_To_Considered_Harmful.html" title="goto">Edsger Dijkstra</a>\n</div>\n\n\n\n\n<div style="height:0;width:0;">&nbsp;</div>')));
 var midtro1_3=text('<div style="height:0;width:0;">&nbsp;</div><p>Callbacks are used to structure programs. They let us say, “When this value is ready, go to another function and run that.” From there, maybe you go to <em>another</em> function and run that too. Pretty soon you are jumping around the whole codebase.</p>\n<p>If you have worked with <a href="http://en.wikipedia.org/wiki/Ajax_(programming)" title="AJAX">AJAX</a> or <a href="http://nodejs.org" title="node.js">node.js</a> or any other callback heavy framework, you have probably been to Callback Hell. Your whole application ends up being passed around as callbacks, making the code extremely difficult to read and maintain. The resulting tangled mess of code is often pejoritively called <a href="http://en.wikipedia.org/wiki/Spaghetti_code" title="Spaghetti code">spaghetti code</a>, a term borrowed from the days of <code>goto</code>.</p>\n<p>Just like <code>goto</code>, these callbacks force you to jump around your codebase in a way that is really hard to understand. You basically have to read the whole program to understand what any individual function does.</p>\n<p>And good luck if you want to add something to your code. A change in one function may break functions that <em>appear</em> to be unrelated (the functions may never even appear together in the entire codebase, connected only by deeply nested callbacks). You\'ll usually find yourself carefully tracing through the entire sequence of callbacks to find out what your change will really do.</p>\n<p>If you are not convinced that callbacks and <code>goto</code> are equally harmful, read Edsger Dijkstra\'s famous <a href="http://www.u.arizona.edu/~rubinson/copyright_violations/Go_To_Considered_Harmful.html" title="goto">“Go To Statement Considered Harmful”</a> and replace the mentions of <code>goto</code> with mentions of callbacks.</p>\n<p>Okay, so there are a lot of things to dislike about callbacks, but they <em>do</em> serve a vital role in modern programs. In an effort to reach a better solution we must ask: why do we <em>really</em> need callbacks? What task do they perform? What is their fundamental role in our programs?</p>\n<p>Well we often want to say, “When this value is ready, take this action.” This is a time-dependent relationship. We depend on a value as it changes over time. We also want to say, “While this is happening, that can happen too.” This is a time-dependent relationship too. These computations can happen concurrently. These time relationships are not covered by traditional control structures, so we use the modern <code>goto</code> to work around it.</p>\n<h2 id="a-preview-of-the-solution">A Preview of the Solution</h2>\n<p>Just like <code>goto</code>, callbacks lead to non-linear code that is hard to read, maintain, and understand. And just like with <code>goto</code>, this problem can be solved by introducing higher level control flow mechanisms. So if you want to escape from Callback Hell, you need to understand <a href="/learn/What-is-FRP.elm" title="FRP">Functional Reactive Programming</a> (FRP). In short:</p>\n<div style="text-align:center">\n<a href="http://www.u.arizona.edu/~rubinson/copyright_violations/Go_To_Considered_Harmful.html" title="goto">goto</a>   <strong>:</strong>   <a href="http://en.wikipedia.org/wiki/Structured_programming" title="Structured Programming">structured programming</a>   <strong>: :</strong>   <a href="http://en.wikipedia.org/wiki/Callback_(computer_programming)" title="Callbacks">callbacks</a>   <strong>:</strong>   <a href="/learn/What-is-FRP.elm" title="FRP">reactive programming</a>\n</div>\n\n<br/><div style="height:0;width:0;">&nbsp;</div>');
 var midtro2_4=text('<div style="height:0;width:0;">&nbsp;</div><p><a href="/learn/What-is-FRP.elm" title="FRP">Functional Reactive Programming</a> (FRP) is a high-level framework for describing time-dependent relationships. FRP formalizes these time-dependencies, resulting in simple syntax and semantics.</p>\n<p>FRP lets you make asynchronous calls without the callbacks. Without the non-linear control flow. Without the headache. You can write code that is both readable <em>and</em> responsive.</p>\n<p>To understand the existing problem and how it is solved with FRP, let\'s make this more concrete. The following example will explain the current state of affairs and fully explain how to create readable, responsive code that is entirely free of callbacks.</p><div style="height:0;width:0;">&nbsp;</div>');
 var funcs_5=above(spacer(170)(300))(width(170)(text('<div style="height:0;width:0;">&nbsp;</div><div style="color:#666;font-size:0.6em;text-align:left">\n<strong>Function Specifications</strong>\n</div>\n<div style="height:0.5em"></div>\n<div style="color:#666;font-size:0.6em;text-align:left">\n<code>requestTag</code> which turns a tag – such as <code>&quot;badger&quot;</code> – into a valid Flickr API request. These requests will return a JSON object containing a list of <code>&quot;badger&quot;</code> photos.\n</div>\n<div style="height:0.5em"></div>\n<div style="color:#666;font-size:0.6em;text-align:left">\n<code>requestOneFrom</code> takes a JSON object of photos and turns it into a request for just <em>one</em> photo. This request will return a JSON object of size options. Flickr is basically asking, “Do you want low resolution? Original quality? 800 by 600? ...” This function also handles any errors that might have occured with the previous request.\n</div>\n<div style="height:0.5em"></div>\n<div style="color:#666;font-size:0.6em;text-align:left">\n<code>sizesToPhoto</code> turns a JSON object of sizes options into an actual image that we can use. Again, this function handles any errors that might have occured with the previous request.\n</div>\n<div style="height:0.5em"></div>\n<div style="color:#666;font-size:0.6em;text-align:left">\n<code>drawOnScreen</code> puts the image on screen for the user to see. You do not need to mess around with the DOM in <a href="/">Elm</a>, so this function only gets used in the JS code.\n</div>\n\n\n<div style="height:0;width:0;">&nbsp;</div>')));
 var midtro3_6=text('<div style="height:0;width:0;">&nbsp;</div><h2 id="case-study-using-the-flickr-api">Case Study: Using the Flickr API</h2>\n<p>Flickr – a photo sharing service – exposes an <a href="http://www.flickr.com/services/api/" title="Flickr API">API</a> that allows you to programmatically find and download photos. We want to find an image with a user defined tag. So if I ask for “Tokyo” I should get back a random image with a Tokyo tag.</p>\n<p>This requires two explicit HTTP requests to Flickr, one to find some tagged photos and another to get the size options for a given image.</p>\n<p>We will perform this task three ways: synchronously, asynchronously with callbacks, and asynchronously with FRP.</p>\n<h4 id="readable-but-unresponsive">1. Readable but Unresponsive</h4>\n<p>First let\'s do this with synchronous HTTP requests. We will rely on a couple of functions specified to the right. Here is our code:</p>\n<pre><code>    function getPhoto(tag) {\n        var photoList  = syncGet(requestTag(tag));\n        var photoSizes = syncGet(requestOneFrom(photoList));\n        return sizesToPhoto(photoSizes);\n    }\n\n    drawOnScreen(getPhoto(&#39;tokyo&#39;));</code></pre>\n<p>It\'s pretty clear what is going on here. The <code>syncGet</code> function takes a request and blocks until it receives a response. The logic of the program is simple and linear. If you wanted to add anything, it is pretty obvious where it would go. You never have moments where you need a value but it does not exist yet.</p>\n<p>This code is really nice to read, but it will make your whole application freeze for the duration of the HTTP requests. It basically dodges the issue of time-dependence by just freezing if it is waiting for a value. This blocks everything in the program. Mouse and keyboard input just piles up, waiting to be processed, presenting the user with an unresponsive app. This is not an acceptable user experience.</p>\n<h4 id="responsive-but-unreadable">2. Responsive but Unreadable</h4>\n<p>The current solution is to instead make asynchronous HTTP requests (AJAX requests) that use callbacks that give finer-grained control over time-dependencies.</p>\n<pre><code>    function getPhoto(tag, handlerCallback) {\n        asyncGet(requestTag(tag), function(photoList) {\n            asyncGet(requestOneFrom(photoList), function(photoSizes) {\n                handlerCallback(sizesToPhoto(photoSizes));\n            });\n        });\n    }\n\n    getPhoto(&#39;tokyo&#39;, drawOnScreen);</code></pre>\n<p>The <code>asyncGet</code> function takes a request and a callback to run once a response is received. We can now say, “These computations must happen one after another, but other things can happen in the meantime.”</p>\n<p>Yay, we solved the problem of the site freezing, but now our code is a mess of deeply nested functions that is annoying to write and unpleasant to read and maintain. This is a glimpse into Callback Hell.</p>\n<p>We have effectively done a manual conversion to <a href="http://matt.might.net/articles/by-example-continuation-passing-style/" title="cps">continuation passing style (CPS)</a>, a common compiler technique for functional languages.</p>\n<p>CPS is great for compilers because it is easy to map onto assembly-level jumps (i.e. <code>goto</code>), helping <a href="http://matt.might.net/articles/cps-conversion/" title="Compiling with Continuations">make functional languages efficient</a>! CPS is terrible for humans for the same reason. It is pretty much the same as using <code>goto</code> to structure your programs.</p><div style="height:0;width:0;">&nbsp;</div>');
 var asyncElm1_7=text('<div style="height:0;width:0;">&nbsp;</div><h4 id="readable-and-responsive">3. Readable <em>and</em> Responsive</h4>\n<p><a href="/learn/What-is-FRP.elm" title="FRP">Functional Reactive Programming</a> uses <em>signals</em>, values that change over time, to represent all interactive time-varying content. For example, the value of a text input field is a “signal” because it changes over time. We can create such a signal with:</p>\n<pre><code>    (inputField, tags) = Input.textField &quot;Tag&quot;</code></pre>\n<p>This creates two values. The first is a visual element called <code>inputField</code> that users can type into. This is a normal text box. The second is a signal called <code>tags</code>. The value of <code>tags</code> changes automatically as the user types into <code>inputField</code>. Here are the <code>inputField</code> and the <code>tags</code> signal in action. Try typing into the input box to see <code>tags</code> update automatically.</p><div style="height:0;width:0;">&nbsp;</div>');
 var asyncElm2_8=text('<div style="height:0;width:0;">&nbsp;</div><p>We can then do all sorts of computations with <code>tags</code>. When <code>tags</code> changes the signals that depend on it change automatically:</p><div style="height:0;width:0;">&nbsp;</div>');
 var asyncElm3_9=text('<div style="height:0;width:0;">&nbsp;</div><p>The <code>lift</code> function is used to transform a signal. It takes functions such as <code>length</code>, <code>reverse</code>, or <code>requestTag</code> and applies them to a signal. This lets us create new signals that automatically change whenever <code>tags</code> changes.</p>\n<p>We are particularly interested in the third signal we created. The code <code>(lift requestTag tags)</code> produces a Flickr request that corresponds to the current user input (abbreviated for the sake of presentation). Now we just need to send this request! For this we use the <code>send</code> function:</p><div style="height:0;width:0;">&nbsp;</div>');
 var asyncElm4_10=text('<div style="height:0;width:0;">&nbsp;</div><p>Notice that when <code>tags</code> changes, the result of <code>send</code> does <em>not</em> change immediately. The responses are sent and received asynchronously, so a response only arrives when it is ready. In the meantime, your program is free to go about its normal business.</p>\n<p>This is great because it allows us to have asynchrony without leaving the conceptual framework of signals. The response is just another signal, exactly the same as <code>tags</code>. We can turn its values into requests and send them too. In fact, that\'s exactly what we are going to do. Here is the full Elm code for making many requests to the Flickr API:</p>\n<pre><code>    getPhotos tags =\n        let photoList  = send (lift requestTag tags) in\n        let photoSizes = send (lift requestOneFrom photoList) in\n            lift sizesToPhoto photoSizes</code></pre>\n<p>We have effectively set up a processing pipeline of how to handle user input: we take in a tag, turn it into a request, send it, turn the response into a new request, send it, and finally turn <em>that</em> response into an image!</p>\n<p>We have clear, linear control flow, and the resulting program automatically optimizes for asynchrony. It does not block while waiting for a response and our program is still well defined. We now have the readability of synchronous code with the efficiency of asynchronous callbacks. There is no trade-off between readability and responsiveness!</p>\n<p>And because it is so easy to work with graphics in Elm, we can create a workable Flickr search interface with only four additional lines of code! The <a href="/edit/examples/Intermediate/Flickr.elm" title="Flickr API Example">full source code and interface can be seen here</a>, with a more idiomatic implementation of <code>getPhotos</code> that takes only one line. Take a look! All of the graphics code lives in the definition of <code>scene</code>, taking up a grand total of two lines. All told, <a href="/edit/examples/Intermediate/Flickr.elm" title="Flickr API Example">the core logic</a> is seven lines from start to finish.</p>\n<p>In fact, here is an abbreviated version that fits in this blog post:</p>\n<pre><code>    scene img = flow down [ container 300  60 middle inputField\n                          , fittedImage 300 300 img ]\n\n    main = lift scene (getPhotos (dropRepeats tags))</code></pre>\n<p>In <code>scene</code> we stack two elements vertically so that they flow downward. The first one is a 300 by 60 container with our <code>inputField</code> text field right in the middle. The second is an image that is automatically cropped to fit nicely in a 300 by 300 square. The <code>main</code> function is what actually gets put on screen. The only new thing in this line is <code>dropRepeats</code> which filters out any values that are repeated, cutting down the number of HTTP requests we make. The result looks like this:</p><div style="height:0;width:0;">&nbsp;</div>');
 var Tuple2$tagInput_tags__11=Input.textField(Value.str("Flickr Search"));
 var tagInput__12=function(){
 switch(Tuple2$tagInput_tags__11[0]){
  case "Tuple2":
  return Tuple2$tagInput_tags__11[1];
 }
 throw "Non-exhaustive pattern match in case";}();
 var tags__13=function(){
 switch(Tuple2$tagInput_tags__11[0]){
  case "Tuple2":
  return Tuple2$tagInput_tags__11[2];
 }
 throw "Non-exhaustive pattern match in case";}();
 var flickrSearch_16=lift(scene_15)(getPhotos_14(dropRepeats(tags__13)));
 var flickrRequest_17=Value.str("http://api.flickr.com/services/rest/?format=json&nojsoncallback=1&api_key=256663858aa10e52a838a58b7866d858");
 var outro_22=text('<div style="height:0;width:0;">&nbsp;</div><h2 id="conclusions">Conclusions</h2>\n<p>Callbacks are the modern <code>goto</code>. Callbacks result in non-linear code that is hard to read, maintain, and understand. Functional Reactive Programming introduces high-level control structures that let you easily express time-dependencies. The resulting code is both readable, responsive, and significantly more concise.</p>\n<p>Signals can express <a href="/docs/Signal/Signal.elm" title="Signal Docs">many different time-relationships</a>, such as dependence on the <a href="/edit/examples/Intermediate/Clock.elm" title="Clock">present</a> or <a href="/edit/examples/Intermediate/Stamps.elm" title="Stamps">past</a>, time-sensitive <a href="/edit/examples/Reactive/SampleOn.elm" title="sampleOn">sampling</a> and <a href="/edit/examples/Reactive/KeepIf.elm" title="keepIf">filtering</a>, and <a href="/edit/examples/JavaScript/ZipCodes.elm" title="Zip Codes">asynchrony</a>. This makes it much easier to deal with complicated time-dependent interactions, a task that is extremely common when designing user interfaces.</p>\n<p>Look out for an upcoming post on <strong>integrating Elm with JS code</strong>. This post will show how Elm can be used to handle your time dependent logic without disrupting an existing codebase. So you can use FRP to escape Callback Hell and still directly use JavaScript, JQuery, Bootstrap, or any other existing web technology. Until then, you can read up on the <a href="http://www.testblogpleaseignore.com/2012/06/29/announcing-elm-0-3-5-javascript-integration-signal-filters-and-more/" title="JavaScript Event Interface">JavaScript Event Interface</a> which makes this all possible.</p>\n<p>If you interested in this approach, <a href="https://github.com/evancz/Elm/blob/master/README.md#elm" title="Dowload">download Elm</a> or <a href="http://elm-lang.org/edit/examples/Basic.elm">experiment online</a>! Elm is only at version 0.5, but it already has lots of great <a href="/Documentation.elm">libraries</a>. If you feel like there are some libraries or features missing, <a href="/Contribute.elm">you can help add them</a>.</p>\n<p>If you have questions or want to learn more, there are lots of helpful resources. This <a href="http://www.testblogpleaseignore.com/wp-content/uploads/2012/04/thesis.pdf" title="thesis">thesis</a> has much more information on how asynchrony works in Elm. It also describes the history of FRP. It is quite accessible even if you do not have any experience reading academic papers. You can also email <a href="https://groups.google.com/forum/?fromgroups#!forum/elm-discuss" title="elm-discuss">the list</a> or ask questions on the <a href="http://webchat.freenode.net/?channels=elm" title="#elm channel">#elm channel at freenode</a>.</p><div style="height:0;width:0;">&nbsp;</div>');
 var Tuple2$inputFieldtags_23=Input.textField(Value.str("Tag"));
 var inputField_24=function(){
 switch(Tuple2$inputFieldtags_23[0]){
  case "Tuple2":
  return Tuple2$inputFieldtags_23[1];
 }
 throw "Non-exhaustive pattern match in case";}();
 var tags_25=function(){
 switch(Tuple2$inputFieldtags_23[0]){
  case "Tuple2":
  return Tuple2$inputFieldtags_23[2];
 }
 throw "Non-exhaustive pattern match in case";}();
 var code_26=function(x){
  return text(monospace(toText(x)));};
 var defaultContent_34=content_33(600);
 var everything_37=lift3(blog_35)(tags_25)(HTTP.sendGet(lift(requestTag__36)(tags_25)))(flickrSearch_16);
 var main_38=lift2(skeleton)(everything_37)(Window.width);
 var titles_39=constant(JavaScript.castStringToJSString(Value.str("Escape from Callback Hell")));
 function getPhotos_14(tags_44){
  return function(){
   var photoList_45=send(lift(requestTag_19)(tags_44));
   return function(){
    var photoSizes_46=send(lift(requestOneFrom_20)(photoList_45));
    return lift(sizesToPhoto_21)(photoSizes_46);}();}();};
 function scene_15(img_47){
  return flow(down)(["Cons",container(300)(60)(middle)(tagInput__12),["Cons",fittedImage(300)(300)(img_47),["Nil"]]]);};
 function extract_18(response_48){
  return function(){
  switch(response_48[0]){
   case "Success":
   return JSON.fromString(response_48[1]);
  }
  return empty;}();};
 function requestTag_19(tag_50){
  return (eq(tag_50,Value.str(""))?get(Value.str("")):get(concat(["Cons",flickrRequest_17,["Cons",Value.str("&method=flickr.photos.search&sort=random&per_page=10&tags="),["Cons",tag_50,["Nil"]]]])));};
 function requestOneFrom_20(photoList_51){
  return function(){
   function getPhotoID_52(json_54){
    return function(){
    var case0=findArray(Value.str("photo"))(findObject(Value.str("photos"))(json_54));
    switch(case0[0]){
     case "Cons":
     switch(case0[1][0]){
      case "JsonObject":
      return findString(Value.str("id"))(case0[1][1]);
     }break;
    }
    return Value.str("");}();};
   function requestSizes_53(id_57){
    return (eq(id_57,Value.str(""))?Value.str(""):concat(["Cons",flickrRequest_17,["Cons",Value.str("&method=flickr.photos.getSizes&photo_id="),["Cons",id_57,["Nil"]]]]));};
   return get(requestSizes_53(getPhotoID_52(extract_18(photoList_51))));}();};
 function sizesToPhoto_21(sizeOptions_58){
  return function(){
   function getImg_59(sizes_60){
    return function(){
    switch(sizes_60[0]){
     case "Cons":
     switch(sizes_60[2][0]){
      case "Cons":
      switch(sizes_60[2][2][0]){
       case "Cons":
       switch(sizes_60[2][2][2][0]){
        case "Cons":
        switch(sizes_60[2][2][2][2][0]){
         case "Cons":
         switch(sizes_60[2][2][2][2][2][0]){
          case "Cons":
          switch(sizes_60[2][2][2][2][2][1][0]){
           case "JsonObject":
           return findString(Value.str("source"))(sizes_60[2][2][2][2][2][1][1]);
          }break;
         }break;
        }break;
       }break;
      }break;
     }
     switch(sizes_60[1][0]){
      case "JsonObject":
      return findString(Value.str("source"))(sizes_60[1][1]);
     }break;
    }
    return Value.str("/grey.jpg");}();};
   return getImg_59(findArray(Value.str("size"))(findObject(Value.str("sizes"))(extract_18(sizeOptions_58))));}();};
 function box_27(w_67){
  return function(e_68){
   return container(w_67)(30)(middle)(e_68);};};
 function pairing_28(w_69){
  return function(left_70){
   return function(right_71){
    return beside(box_27(div(w_69)(2))(left_70))(box_27(div(w_69)(2))(right_71));};};};
 function requestTagSimple_29(t_72){
  return (eq(t_72,Value.str(""))?Value.str(""):Value.append(Value.str("api.flickr.com/?tags="),t_72));};
 function dropTil_30(s_73){
  return function(){
  switch(s_73[0]){
   case "Cons":
   return (eq(s_73[1],'[')?s_73[2]:dropTil_30(s_73[2]));
  }
  return s_73;}();};
 function format_31(r_76){
  return map(function(c_77){
   return (eq(c_77,'"')?'\'':c_77);})(take(19)(dropTil_30(r_76)));};
 function showResponse_32(r_78){
  return code_26(function(){
  switch(r_78[0]){
   case "Failure":
   return Value.append(Value.str("Failure "),Value.append(show(r_78[1]),Value.str(" \"...\"")));
   case "Success":
   return Value.append(Value.str("Success \"... "),Value.append(format_31(r_78[1]),Value.str(" ...\"")));
   case "Waiting":
   return Value.str("Waiting");
  }
  throw "Non-exhaustive pattern match in case";}());};
 function content_33(w_81){
  return function(tags_82){
   return function(response_83){
    return function(search_84){
     return function(){
      function sideBySide_85(big_86){
       return function(small_87){
        return flow(right)(["Cons",width(w_81)(big_86),["Cons",spacer(30)(100),["Cons",small_87,["Nil"]]]]);};};
      return function(){
       function codePair_88(l_89){
        return function(r_90){
         return pairing_28(w_81)(code_26(l_89))(asText(r_90));};};
       return function(){
        var asyncElm_91=flow(down)(map(width(w_81))(["Cons",asyncElm1_7,["Cons",pairing_28(w_81)(inputField_24)(asText(tags_82)),["Cons",asyncElm2_8,["Cons",codePair_88(Value.str("lift length tags"))(length(tags_82)),["Cons",codePair_88(Value.str("lift reverse tags"))(reverse(tags_82)),["Cons",codePair_88(Value.str("lift requestTag tags"))(requestTagSimple_29(tags_82)),["Cons",asyncElm3_9,["Cons",pairing_28(w_81)(code_26(Value.str("send (lift requestTag tags)")))(showResponse_32(response_83)),["Cons",asyncElm4_10,["Nil"]]]]]]]]]]));
        return flow(down)(["Cons",width(w_81)(intro_0),["Cons",sideBySide_85(midtro1_3)(quote1_1),["Cons",sideBySide_85(midtro2_4)(quote2_2),["Cons",sideBySide_85(midtro3_6)(funcs_5),["Cons",asyncElm_91,["Cons",container(w_81)(heightOf(search_84))(middle)(search_84),["Cons",width(w_81)(outro_22),["Nil"]]]]]]]]);}();}();}();};};};};
 function blog_35(tags_92){
  return function(response_93){
   return function(search_94){
    return function(w__95){
     return function(){
      var w_96=(w__95-200);
      return function(){
       var c_97=(eq(w__95,800)?defaultContent_34(tags_92)(response_93)(search_94):content_33(w_96)(tags_92)(response_93)(search_94));
       return container(w__95)(heightOf(c_97))(middle)(c_97);}();}();};};};};
 function requestTag__36(tag_98){
  return (eq(tag_98,Value.str(""))?Value.str(""):concat(["Cons",flickrRequest_17,["Cons",Value.str("&method=flickr.photos.search&sort=random&per_page=10&tags="),["Cons",tag_98,["Nil"]]]]));};
 lift(function(v) { var e = document.createEvent('Event');e.initEvent('elm_title', true, true);e.value = v;document.dispatchEvent(e); return v; })(titles_39);
 return {intro:intro_0,quote1:quote1_1,quote2:quote2_2,midtro1:midtro1_3,midtro2:midtro2_4,funcs:funcs_5,midtro3:midtro3_6,asyncElm1:asyncElm1_7,asyncElm2:asyncElm2_8,asyncElm3:asyncElm3_9,asyncElm4:asyncElm4_10,Tuple2$tagInput_tags_:Tuple2$tagInput_tags__11,tagInput_:tagInput__12,tags_:tags__13,getPhotos:getPhotos_14,scene:scene_15,flickrSearch:flickrSearch_16,flickrRequest:flickrRequest_17,extract:extract_18,requestTag:requestTag_19,requestOneFrom:requestOneFrom_20,sizesToPhoto:sizesToPhoto_21,outro:outro_22,Tuple2$inputFieldtags:Tuple2$inputFieldtags_23,inputField:inputField_24,tags:tags_25,code:code_26,box:box_27,pairing:pairing_28,requestTagSimple:requestTagSimple_29,dropTil:dropTil_30,format:format_31,showResponse:showResponse_32,content:content_33,defaultContent:defaultContent_34,blog:blog_35,requestTag_:requestTag__36,everything:everything_37,main:main_38,titles:titles_39};}();
Elm.main=function(){
 return Elm.Main.main;};
} catch (e) {Elm.main=function() {var msg = ('<br/><h2>Your browser may not be supported. Are you using a modern browser?</h2>' + '<br/><span style="color:grey">Runtime Error in Main module:<br/>' + e + '<br/><br/>The problem may stem from an improper usage of:<br/>above, beside, empty, skeleton</span>');document.body.innerHTML = Text.monospace(msg);throw e;};}</script><script type="text/javascript">Dispatcher.initialize()</script><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-25827182-1']);
_gaq.push(['_trackPageview']);
(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>
